---
title: "Holiday Commits"
author: "Yim Register"
date: "7/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Curiosity killed the cat, but satisfaction brought it back

Sometimes, some of the most intricate problems arise from simple musings among friends. This is one of the beautiful things about problem solving, programming, and statistics. When you are curious enough and excited about a problem, you may find yourself exploring every caveat just to prove your point! (*Be careful though, don't forgo sleep. We cover the detrimental effects of missing sleep on your coding performance in another lesson!*) While it is very important to tackle real problems that are genuinely affecting people's lives, first we have to learn to wrangle statistics and ask the right kinds of questions. Learning this skill will help you to ask critical questions when it really counts, like when building software for hospitals, news sites, financial institutions, or maybe the next rocket to Mars. One of the best ways to teach these skills is to lock on to a personally meaningful, but low-stakes, question; **and answer it**.

## Independence Day vs. Canada Day: Who is Committing on GitHub?
<center><img src="../bin/images/canadaday.png" width="200" style="margin-right:50px;"/>
<img src="../bin/images/july4.jpg" width="200"/><br><br></center>


In Seattle, I find myself bumping into Canadians almost every day (oops, sorry eh!). Turns out, **Canada Day** and **Independence Day** are only days apart, and it piqued my curiosity. So together, we will travel down a road of questions that investiate the GitHub patterns of users from the US and Canada, during their respective national holidays.


## GHTorrent and BigRQuery
We need to begin by getting **data**. Luckily [the GHTorrent project](http://ghtorrent.org) has been archiving data from the GitHub API for the past several years, and we can get access to *commits, users, forks, repos, locations* and more. While there are several ways to load this data into R, we are going to rely on `bigrquery` to interface with Google BigQuery and the public GHTorrent data on the Google Cloud. Here are the steps you need to take:

* Set up an account with [Google Cloud](https://cloud.google.com/). They do require a credit card number, which is ridiculous. But they will *not* auto-charge you when your free trial is up.
* Create a project from the Google Cloud console. Name it using something you'd like to use to access the project with `bigrquery`
* Make sure to enable the BigQuery API for the project. Go to the APIs & Services card on the console, and navigate to "Enable APIs and Services" where you can search for 'BigQuery' and enable it.
* You will be able to test out SQL queries on [here](https://bigquery.cloud.google.com)
* The GHTorrent project for BigQuery is located [here](https://bigquery.cloud.google.com/dataset/ghtorrent-bq:ght), with a small tutorial [here](http://ghtorrent.org/gcloud.html)

The next piece of this is to not only understand that the data is being held on the Google Cloud (that we can access with SQL queries), but to understand how we can do that from our local machines, in R. We will use the [`bigrquery`](https://www.rdocumentation.org/packages/bigrquery/versions/0.4.1) package, with a tutorial [here](https://cloud.google.com/blog/products/gcp/google-cloud-platform-for-data-scientists-using-r-with-google-bigquery). `bigrquery` allows us to link our R code to our project on the cloud. You will be asked to authenticate.


## Alan Turing's Birthday Examples (learn some SQL queries)

Here are some examples for using `bigrquery` to access GHTorrent data. Here, we take a look at Alan Turing's birthday (June 23) for the year 2016.This should help you get the hang of some SQL commands and collecting data. These examples certainly don't answer anything of note, but perhaps you can think of more ways to make queries like these ones more meaningful.

```{r}
library(bigrquery)
library(ggplot2)
set_service_token("../../servicetoken.json") # you will need to get your own service token from your account. Don't share this!
project <- "gitstats" #your project name here

# walking through a small SQL example
# languge with most commits on Alan Turing's birthday in 2016 

sql_example <- "select  p.language as language, count(c.id) as num_commits
from [ghtorrent-bq.ght.project_commits] pc join
     (SELECT id, author_id, created_at FROM [ghtorrent-bq.ght.commits] WHERE
     date(created_at) = date('2016-06-23') )c on pc.commit_id = c.id join
     (SELECT id, language, description
     FROM [ghtorrent-bq.ght.projects] WHERE language != 'null')p on p.id = pc.project_id join
     (SELECT login,  id
     FROM [ghtorrent-bq.ght.users]) u on c.author_id = u.id,
group by language
order by num_commits desc;"

r_sql <- "select  p.language as language, date(created_at) as day,count(c.id) as num_commits
from [ghtorrent-bq.ght.project_commits] pc join
     (SELECT id, author_id, created_at FROM [ghtorrent-bq.ght.commits] WHERE
     date(created_at) between date('2012-01-01')
                          and  date('2016-09-05') )c on pc.commit_id = c.id join
     (SELECT id, language, description
     FROM [ghtorrent-bq.ght.projects] WHERE language == 'R' || language == 'Python')p on p.id = pc.project_id join
     (SELECT login,  id
     FROM [ghtorrent-bq.ght.users]) u on c.author_id = u.id,
group by language,day
order by num_commits desc;"


example  <- query_exec(r_sql, project = project, useLegacySql = FALSE)

head(example)
View(example)

example <-example[order(example$day),]
example$n <-seq.int(nrow(example))
example$csum <- ave(example$num_commits, example$language, FUN=cumsum)
example <- example %>%
  group_by(language) %>%
  mutate(sum_commits = cumsum(num_commits))

plt = ggplot(example,aes(n,csum,color=language))+
  geom_line()+
  theme_bw()+
  ggtitle("R Commits over time")+
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE))
plt
ggsave("commits.png",plt)


plt = ggplot(example[1:6,],aes(language,num_commits,fill=language))+
  geom_bar(stat="identity")+
  ggtitle("Commits on Alan Turing's Birthday by Language")+
  theme_bw()
plt
```

#### I can't imagine that Alan Turing would have been the biggest JavaScript fan. Let's take a look at projects where the project description includes "AI". Here, we see Python emerge as top commits for the day.

```{r}
# languge with most commits on Alan Turing's birthday in 2016 

sql_example2 <- "select p.description as description, p.language as language, count(c.id) as num_commits
from [ghtorrent-bq.ght.project_commits] pc join
     (SELECT id, author_id, created_at FROM [ghtorrent-bq.ght.commits] WHERE
     date(created_at) = date('2016-06-23') )c on pc.commit_id = c.id join
     (SELECT id, language, description
     FROM [ghtorrent-bq.ght.projects] WHERE language != 'null' and description LIKE '%AI%')p on p.id = pc.project_id join
     (SELECT login,  id
     FROM [ghtorrent-bq.ght.users]) u on c.author_id = u.id,
group by description,language
order by num_commits desc;"

example2  <- query_exec(sql_example2, project = project, useLegacySql = FALSE)

plt = ggplot(example2[1:6,],aes(language,num_commits,fill=language))+
  geom_bar(stat="identity")+
  ggtitle("Commits to 'AI' Projects on Alan Turing's Birthday",subtitle="Who would even want to know this?")+
  theme_bw()
plt

python_desc <- example2[example2$language=='Python',]
python_desc <- python_desc[order(-python_desc$num_commits),]

library(knitr)
kable(python_desc[1:10,])
```

## Back to Serious Business! Who is committing on July 4th?
Alright, now that we have explored how to use `bigrquery` and generate some simple queries and plots, let's get back to our Canada vs. USA comparison. The queries will get more complex as we continue to explore, and refine what we want to know. You may be developing an intuition for what you believe to be true; of course people don't commit on a holiday! They're not working! But what about the case where company repos are kept private, and the data that GHTorrent has access to is actually "for fun" repos, and a day off is the perfect day for that programmer to keep making their alien game. Intuition is certainly important when asking statistical questions, as it guides us towards different factors to account for and questions to ask. But remember, your intuition may be the exact opposite of someone else's.

### Total Commits

We start by taking a look at the total commits to GitHub on either Canada Day or Independence Day, from either Canada or the United States. We immediately discover that raw count is *not* going to be helpful in making any meaningful comparsions. The US has orders of magnitude more commits on any given day than Canada does. While that is good to know, we need to account for it if we actually want to make comparisons.
```{r}
data_sql <- "select  u.country_code as country, date(c.created_at) as day, count(c.id) as num_commits
from [ghtorrent-bq.ght.project_commits] pc join
     (SELECT id, author_id, created_at FROM [ghtorrent-bq.ght.commits] WHERE
     date(created_at) = date('2016-07-01')
                          or date(created_at)= date('2016-07-04') )c on pc.commit_id = c.id join
     (SELECT id,
     FROM [ghtorrent-bq.ght.projects]) p on p.id = pc.project_id join
     (SELECT login, location, id, country_code,
     FROM [ghtorrent-bq.ght.users]
     WHERE country_code = 'us' or country_code = 'ca') u on c.author_id = u.id,
group by country, day
order by num_commits desc;"

total_commits  <- query_exec(data_sql, project = project, useLegacySql = FALSE)

kable(total_commits)

plt = ggplot(total_commits, aes(day,num_commits,fill=country))+
  geom_bar(stat="identity",position="dodge")+
  ggtitle("Number of Holiday Commits (Canada v. USA)")+
  theme_bw()
plt

```

## Relative Commits
What we actually need to care about is, *on average* do number of commits differ on a holiday? In order to do that, let's look at number of commits per day across a year sample, between Canada and USA. Next, we will compute the **z-score** for each day, comparing each day's number of commits to how it deviates from the number of commits on average.
```{r fig.width=13,fig.height=4}
data_sql <- "select  u.country_code as country, date(c.created_at) as day, count(c.id) as num_commits
from [ghtorrent-bq.ght.project_commits] pc join
     (SELECT id, author_id, created_at FROM [ghtorrent-bq.ght.commits] WHERE
     date(created_at) between date('2016-01-01')
                          and  date('2016-09-05') )c on pc.commit_id = c.id join
     (SELECT id,
     FROM [ghtorrent-bq.ght.projects]) p on p.id = pc.project_id join
     (SELECT login, location, id, country_code,
     FROM [ghtorrent-bq.ght.users]
     WHERE country_code = 'us' or country_code = 'ca') u on c.author_id = u.id,
group by country, day
order by num_commits desc;"

year_commits  <- query_exec(data_sql, project = project, useLegacySql = FALSE)

plt = ggplot(year_commits,aes(day,num_commits,colour=country))+
  geom_line(aes(group=country))+
  theme_bw()+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+
  ggtitle("2016 Commits on GitHub (Canada vs. USA)", subtitle="January 1 - September 5")
plt
```


```{r, message=FALSE}
#let's do some important checks on outliers
bp <- boxplot(year_commits$num_commits ~ year_commits$country)
year_commits <- year_commits[!(year_commits$num_commits %in% bp$out),]
bp <- boxplot(year_commits$num_commits ~ year_commits$country)

library(plyr)
library(dplyr)
summary <- year_commits %>% 
  group_by(country) %>%
  summarise(avg = mean(num_commits),sd=sd(num_commits))

kable(summary)

head(year_commits)

#TODO group by country and z scale each and then plot by day


```

```{r}
scaled <-ddply(year_commits,c("country"),transform,scaled_commits = scale(num_commits))
#am I even allowed to do this if it's not normal?
head(scaled)

#notice how now they overlap. We predicted that, because there's no real reason that Canada should be all that different from USA. We do see some differences, but this could also be due to the fact that Canada has less users/commits overall

# you can see that they both have weekends pretty clearly
scaled$weekday <- weekdays(as.Date(scaled$day))

#it's not normal so we can't really use scaled for anything
hist(year_commits$num_commits)


plt = ggplot(scaled,aes(day,scaled_commits,colour=country))+
  geom_line(aes(group=country))+
  theme_bw()+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+
  ggtitle("2016 SCALED Commits on GitHub (Canada vs. USA)", subtitle="January 1 - September 5")
plt
```
## Testing for normality (nothing is normal)


## Is a holiday really any different from any other weekday?
```{r fig.height=3}
# usa vs. canada
wilcox.test(scaled$scaled_commits[year_commits$country=='ca'],scaled$scaled_commits[year_commits$country=='us'])
scaled$isWeekend <- 0
scaled$isWeekend[scaled$weekday=='Saturday'|scaled$weekday=='Sunday']<-1
#let's test our sanity?

ggplot(scaled[scaled$isWeekend==1,], aes(x=num_commits,fill=country))+
  geom_histogram()+
  facet_wrap(~country)+
  scale_x_continuous(labels = function(x) format(x, scientific = FALSE))+
  theme_bw()
  
ggplot(scaled[scaled$isWeekend==0,], aes(x=num_commits,fill=country))+
  geom_histogram()+
  facet_wrap(~country)+
  scale_x_continuous(labels = function(x) format(x, scientific = FALSE))+
  theme_bw()


#not normal
ddply(scaled,c('country','isWeekend'),summarise,mean = mean(num_commits),sd(num_commits))
```

## Logistic regression for predicting your weekend commits

```{r}

#is the holiday really any different from any other weekday?
plot(scaled$num_commits,scaled$isWeekend) # plot with body size on x-axis and survival (0 or 1) on y-axis
logistic <- glm(scaled$isWeekend ~ scaled$num_commits, family = "binomial")



vals <- predict(logistic,data.frame(x=scaled$num_commits),type="resp") # draws a curve based on prediction from logistic regression model
plt <- ggplot(aes(num_commits,isWeekend),data=scaled)+
  geom_point(size=1)+
  geom_line(aes(num_commits,vals),color="#8DD3C7",size=1)+
  theme_bw()+
  scale_x_continuous(labels = function(x) format(x, scientific = FALSE))
plt
# there is a true difference
#canada day


```
## Should we take weekday into account?

## Should we look at other years?




